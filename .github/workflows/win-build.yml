name: Build Windows Installer

on:
  workflow_dispatch:

jobs:
  package-windows:
    strategy:
      matrix:
        include:
    
          - name: Windows 11 amd64
            runner: windows-2025
            arch: x64
            driver_arch: amd64
            os_type: win11
    
          - name: Windows 11 arm64
            runner: windows-2025
            arch: arm64
            driver_arch: arm64
            os_type: win11
    
          - name: Windows 10 amd64
            runner: windows-2022
            arch: x64
            driver_arch: amd64
            os_type: win10
    
          - name: Windows 10 arm64
            runner: windows-2022
            arch: arm64
            driver_arch: arm64
            os_type: win10

    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    steps:

    - name: Checkout packaging repo
      uses: actions/checkout@v4

    - name: Download GUI artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        repo: AaryaTalgaonkar/openvpn3-gui
        workflow: build.yml
        branch: main
        name: OpenVPN3-GUI-${{ matrix.name }}
        path: gui
        
    - name: Download Backend artifact
      uses: dawidd6/action-download-artifact@v3
      with:
        repo: AaryaTalgaonkar/openvpn3
        workflow: build.yml
        branch: master
        name: backend-build-win-${{matrix.arch}}
        path: openvpn3

    - name: Install WiX
      shell: powershell
      run: |
        dotnet tool install --global wix
        echo "$env:USERPROFILE\.dotnet\tools" | Out-File -Append -Encoding ascii $env:GITHUB_PATH
    
    - name: Extract TAP Driver Files
      shell: powershell
      run: |
    
        $zipPath = "windows/tap-windows.zip"
        $extractRoot = "tap-extracted"
        $dest = "tap-driver"
    
        Expand-Archive -Path $zipPath -DestinationPath $extractRoot -Force
    
        if ("${{ matrix.os_type }}" -eq "win10") {
            $source = Join-Path $extractRoot "${{ matrix.driver_arch }}/win10"
        }
        else {
            $source = Join-Path $extractRoot "${{ matrix.driver_arch }}"
        }
    
        New-Item -ItemType Directory -Path $dest -Force | Out-Null
    
        Copy-Item "$source/OemVista" -Destination $dest -Recurse -Force
        Copy-Item "$source/tap0901*" -Destination $dest -Recurse -Force
        Copy-Item "$source/tapinstall.exe" -Destination $dest -Force
    
        Write-Host "Driver files extracted successfully."
        
    - name: Build MSI
      shell: powershell
      run: |
        wix build Product.wxs Gui.wxs `
          -arch ${{matrix.arch}} `
          -o IITDelhiVPN-${{matrix.arch}}.msi

    - name: Upload MSI
      uses: actions/upload-artifact@v4
      with:
        name: IITDelhiVPN-${{matrix.arch}}
        path: IITDelhiVPN-${{matrix.arch}}.msi
