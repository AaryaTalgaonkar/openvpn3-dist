name: Build Debian Package

on:
  workflow_dispatch:       
  push:
    tags:
      - 'v*'         
permissions:
  contents: write
jobs:
  package:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:

          # --------------------
          # Ubuntu
          # --------------------
          - name: Ubuntu 22.04 amd64
            runner: ubuntu-22.04
            arch: amd64
            version: 22.04

          - name: Ubuntu 24.04 amd64
            runner: ubuntu-24.04
            arch: amd64
            version: 24.04

          # - name: Ubuntu 22.04 arm64
          #   runner: ubuntu-22.04-arm
          #   arch: arm64
          #   version: 22.04

          - name: Ubuntu 24.04 arm64
            runner: ubuntu-24.04-arm
            arch: arm64
            version: 24.04


    steps:
      - uses: actions/checkout@v4
        
      - name: Download GUI tarball
        uses: dawidd6/action-download-artifact@v3
        with:
          repo: AaryaTalgaonkar/openvpn3-gui
          workflow: lin-build.yml
          branch: main
          name: OpenVPN3-GUI-${{ matrix.name }}
          path: linux

      - name: Download Backend tarball
        uses: dawidd6/action-download-artifact@v3
        with:
          repo: AaryaTalgaonkar/openvpn3-linux
          workflow: lin-build.yml
          branch: master
          name: backend-build-${{ matrix.runner }}
          path: linux

      - name: Extract tarballs into pkgroot
        run: |
          cd linux

          mkdir -p pkgroot

          echo "Extracting Backend..."
          tar -xvf backend-build-${{ matrix.runner }}.tar -C pkgroot
          
          echo "Extracting GUI..."
          tar -xvf "OpenVPN3-GUI-${{ matrix.name }}.tar" -C pkgroot

          echo "Cleaning up tar files..."
          rm -f *.tar.gz

          echo "Final pkgroot structure:"
          ls -lR pkgroot
          
          
      # -----------------------------
      # Create package structure
      # -----------------------------
      - name: Prepare package root
        run: |
          cd linux
          sed -i "s/Architecture:.*/Architecture: ${{ matrix.arch }}/" pkgroot/DEBIAN/control

          chmod 755 pkgroot/DEBIAN/preinst
          chmod 755 pkgroot/DEBIAN/postinst
          chmod 755 pkgroot/DEBIAN/prerm
          chmod 755 pkgroot/DEBIAN/postrm
          chmod 644 pkgroot/DEBIAN/control
      # -----------------------------
      # Build .deb
      # -----------------------------
      - name: Build deb
        run: |
          cd linux
          dpkg-deb --build pkgroot iitdelhivpn_${{ matrix.arch }}-${{matrix.version}}.deb

      # -----------------------------
      # Upload artifact
      # -----------------------------
      - name: Upload deb
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: iitdelhivpn-${{ matrix.arch }}-${{matrix.version}}
          path: linux/iitdelhivpn_${{ matrix.arch }}-${{matrix.version}}.deb

      # -----------------------------
      # Create GitHub Release + Upload .deb
      # -----------------------------
      - name: Upload deb to Release
        if: github.event_name != 'workflow_dispatch'
        uses: softprops/action-gh-release@v2
        with:
          files: linux/iitdelhivpn_${{ matrix.arch }}-${{ matrix.version }}.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
