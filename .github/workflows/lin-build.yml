name: Build Debian Package

on:
  workflow_dispatch:

jobs:
  package:
    name: ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include:

          # --------------------
          # Ubuntu
          # --------------------
          - name: Ubuntu 22.04 amd64
            runner: ubuntu-22.04
            arch: amd64
            version: 22.04

          - name: Ubuntu 24.04 amd64
            runner: ubuntu-24.04
            arch: amd64
            version: 24.04

          # - name: Ubuntu 22.04 arm64
          #   runner: ubuntu-22.04-arm
          #   arch: arm64
          #   version: 22.04

          - name: Ubuntu 24.04 arm64
            runner: ubuntu-24.04-arm
            arch: arm64
            version: 24.04


    steps:
      - uses: actions/checkout@v4

      
      - name: Download GUI artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          repo: AaryaTalgaonkar/openvpn3-gui
          workflow: lin-build.yml
          branch: main
          name: OpenVPN3-GUI-${{ matrix.name }}
          path: linux/gui

      - name: Download Backend artifact
        uses: dawidd6/action-download-artifact@v3
        with:
          repo: AaryaTalgaonkar/openvpn3-linux
          workflow: lin-build.yml
          branch: master
          name: backend-build-${{ matrix.runner }}
          path: linux/backend

      # -----------------------------
      # Create package structure
      # -----------------------------
      - name: Prepare package root
        run: |
          mkdir -p pkgroot/DEBIAN
          mkdir -p pkgroot/usr
          
          cat > pkgroot/DEBIAN/control <<EOF
          Package: iitdelhivpn
          Version: 1.0.0
          Section: net
          Priority: optional
          Architecture: ${{ matrix.arch }}
          Maintainer: IIT Delhi  <you@example.com>
          Description: Custom OpenVPN3 with GUI
           Backend daemon and Qt GUI.
          EOF

          cat > pkgroot/DEBIAN/postinst <<'EOF'
          #!/bin/bash
          set -e
          
          # Create group if not exists
          if ! getent group openvpn >/dev/null; then
              groupadd -r openvpn
          fi
          
          # Create user if not exists
          if ! id -u openvpn >/dev/null 2>&1; then
              useradd -r -s /usr/sbin/nologin -g openvpn openvpn
          fi
          
          # Initialize configs
          if command -v openvpn3-admin >/dev/null; then
              openvpn3-admin init-config --write-configs || true
          fi
          
          # Reload dbus
          systemctl reload dbus || true
          
          exit 0
          EOF

          cat > pkgroot/DEBIAN/prerm <<'EOF'
          #!/bin/bash
          set -e
          
          # Stop services if any
          systemctl stop openvpn3 2>/dev/null || true
          
          exit 0
          EOF

          cat > pkgroot/DEBIAN/postrm <<'EOF'
          #!/bin/bash
          set -e
          
          if [ "$1" = "purge" ]; then
              userdel openvpn 2>/dev/null || true
              groupdel openvpn 2>/dev/null || true
          fi
          
          exit 0
          EOF
          
          cp -r linux/backend/usr/* pkgroot/usr/
          cp -r linux/gui/* pkgroot/usr/
          
          chmod 755 pkgroot/DEBIAN/postinst
          chmod 755 pkgroot/DEBIAN/prerm
          chmod 755 pkgroot/DEBIAN/postrm
          chmod 644 pkgroot/DEBIAN/control
      # -----------------------------
      # Build .deb
      # -----------------------------
      - name: Build deb
        run: |
          dpkg-deb --build pkgroot openvpn3-gui_${{ matrix.arch }}-${{matrix.version}}.deb

      # -----------------------------
      # Upload artifact
      # -----------------------------
      - name: Upload deb
        uses: actions/upload-artifact@v4
        with:
          name: openvpn3-gui-${{ matrix.arch }}-${{matrix.version}}
          path: openvpn3-gui_${{ matrix.arch }}-${{matrix.version}}.deb
